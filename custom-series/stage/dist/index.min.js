/*
* Licensed to the Apache Software Foundation (ASF) under one
* or more contributor license agreements.  See the NOTICE file
* distributed with this work for additional information
* regarding copyright ownership.  The ASF licenses this file
* to you under the Apache License, Version 2.0 (the
* "License"); you may not use this file except in compliance
* with the License.  You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing,
* software distributed under the License is distributed on an
* "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
* KIND, either express or implied.  See the License for the
* specific language governing permissions and limitations
* under the License.
*/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("echarts")):"function"==typeof define&&define.amd?define(["echarts"],t):(e="undefined"!=typeof globalThis?globalThis:e||self).stageCustomSeriesInstaller=t(e.echarts)}(this,(function(e){"use strict";var t=function(t,r){var a,o=r.value(0),h=r.value(1),l=r.value(2),n=r.coord([o,l]),d=r.coord([h,l]),c=r.coord([0,0])[1]-r.coord([0,1])[1],s=r.visual("color"),x=t.itemPayload,f=x.itemStyle||{},y=f.borderRadius||8,u=e.zrUtil.retrieve2(null===(a=x.envelope)||void 0===a?void 0:a.externalRadius,6),v=e.zrUtil.retrieve2(f.verticalMargin,8),g=e.zrUtil.retrieve2(f.minHorizontalSize,3),m=[],p=t.context.boxes||[],M=d[0]-n[0],w=Math.max(M,g),T={x:n[0]-(w-M)/2,y:n[1]-c/2+5+14+v,width:w,height:c-14-5-2*v};m.push({type:"rect",shape:{x:T.x,y:T.y,width:T.width,height:T.height,r:y},style:{fill:s}}),p.push(T),t.context.boxes=p,t.context.renderedStages||(t.context.renderedStages=[]);var P=t.context.renderedStages;if(!P[l]){var I=x.axisLabel||{},S=r.ordinalRawValue(2);"function"==typeof I.formatter&&(S=I.formatter(S,l)),m.push({type:"text",style:{x:t.coordSys.x+5,y:n[1]-c/2+5+14,fill:I.color||"#8A8A8A",text:S,verticalAlign:"bottom"}}),P[l]=!0}if(t.dataIndex===t.dataInsideLength-1){for(var b=[],z=0;z<t.dataInsideLength;z++){var U=r.visual("color",z);b.indexOf(U)<0&&b.push(U)}var A=x.envelope||{};if(!1!==A.show&&p.length>1){var C=e.zrUtil.retrieve2(A.margin,2);p.sort((function(e,t){return e.x-t.x||e.y-t.y}));var L=t.coordSys,R=null==A.dpr?2:A.dpr||1,j=L.width*R,q=L.height*R,E=function(e,t){var i=document.createElement("canvas");return i.width=e,i.height=t,i}(j,q),G=L.x,H=L.y,O=E.getContext("2d");if(b.length>0&&!A.color){var V=O.createLinearGradient(0,0,0,q);for(z=0;z<b.length;z++)V.addColorStop((2*z+1)/(2*b.length),b[z]);O.fillStyle=V}else O.fillStyle=A.color||"#888";var X=e.zrUtil.retrieve2(A.opacity,.25);for(z=0;z<p.length;z++){var Y=p[z];if(i(O,(Y.x-C-G)*R,(Y.y-C-H)*R,(Y.width+2*C)*R,(Y.height+2*C)*R,(Math.min(y,Y.width/2)+C)*R),z>0){O.beginPath();var k=p[z-1],B=k.y>Y.y+Y.height,D=B?k.y-Y.y-Y.height+2*y:Y.y-k.y-k.height+2*y,F=B?Y.y+Y.height-y:k.y+k.height-y;if(Y.x-C>=k.x+k.width+C)continue;if(B){if(Y.x-C-k.x>0){var J=Math.ceil((Y.x-C-G)*R),K=(k.y-C-H)*R,N=Math.min((Y.x-C-k.x)/2,u)*R;O.moveTo(J,K+N),O.arc(J-N,K-N,N,0,Math.PI/2),O.lineTo(J,K+C*R),O.lineTo(J,K-N)}if(Y.x+Y.width-k.x-k.width-C>0){var Q=(Y.y+Y.height+C-H)*R,W=Math.floor((k.x+k.width+C-G)*R);N=Math.min((Y.x+Y.width-k.x-k.width-C)/2,u)*R;O.moveTo(W,Q+N),O.arc(W+N,Q+N,N,Math.PI,1.5*Math.PI),O.lineTo(W,Q-C*R),O.lineTo(W,Q)}}else{if(Y.x-C-k.x>0){J=Math.ceil((Y.x-C-G)*R);var Z=(k.y+k.height+C-H)*R;N=Math.min((Y.x-C-k.x)/2,u)*R;O.moveTo(J,Z+N),O.arc(J-N,Z+N,N,-Math.PI/2,0),O.lineTo(J,Z-C*R),O.lineTo(J-N,Z)}if(Y.x+Y.width-k.x-k.width-C>0){K=(Y.y-C-H)*R,W=Math.floor((k.x+k.width+C-G)*R),N=Math.min((Y.x+Y.width-k.x-k.width-C)/2,u)*R;O.moveTo(W+N,K),O.arc(W+N,K-N,N,Math.PI/2,Math.PI),O.lineTo(W,K+(C+y)*R),O.lineTo(W+N,K)}}O.closePath(),O.fill(),O.fillRect((k.x+k.width+C-G)*R,(F-H)*R,(Y.x-k.x-k.width-2*C)*R,D*R)}}m.push({type:"image",style:{image:E,x:L.x*R,y:L.y*R,opacity:X},silent:!0,scaleX:1/R,scaleY:1/R})}}return{type:"group",children:m}};function i(e,t,i,r,a,o){e.beginPath(),e.moveTo(t+o,i),e.lineTo(t+r-o,i),e.arc(t+r-o,i+o,o,-Math.PI/2,0,!1),e.lineTo(t+r,i+a-o),e.arc(t+r-o,i+a-o,o,0,Math.PI/2,!1),e.lineTo(t+o,i+a),e.arc(t+o,i+a-o,o,Math.PI/2,Math.PI,!1),e.lineTo(t,i+o),e.arc(t+o,i+o,o,Math.PI,1.5*Math.PI,!1),e.closePath(),e.fill()}return{install:function(e){e.registerCustomSeries("stage",t)}}}));